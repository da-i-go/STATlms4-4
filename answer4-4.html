<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta name="robots" content="noindex, nofollow" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>診断結果</title>
    <link rel="stylesheet" href="css/answer.css" />

    <script>
      // 未認証ならログインへ
      if (sessionStorage.getItem("authenticated") !== "true") {
        location.replace("index.html");
      }
    </script>

  </head>

  <body>
    <h1>診断結果</h1>

    <section class="result-section">
      <h2>■ 診断名</h2>
      <p>上腸間膜動脈血栓 / 塞栓</p>
    </section>

    <section class="result-section">
      <h2>■ Key画像</h2>
      <div class="carousel-container">
        <div class="carousel-wrapper">
          <button class="carousel-button prev">❮</button>
          <div class="carousel-track-container">
            <ul class="carousel-track">
            
              <li class="carousel-slide">
                <img src="key-images/key1.jpeg" alt="単純CT" />
                <!-- "ファイル名/画像名" -->
                <p class="caption">当日のCT。<br>
                    上腸間膜動脈抹消が単純CTで淡く高信号。</p>
                <!-- 画像の下につける説明 -->
              </li>

              <li class="carousel-slide">
                <img src="key-images/key2.jpeg" alt="動脈相冠状断" />
                <p class="caption">当日のCT<br>
                    上腸間膜動脈抹消で造影不良が見られる。</p>
              </li>
              
              <li class="carousel-slide">
                <img src="key-images/key3.jpeg" alt="翌日CT" />
                <p class="caption">翌日のCT１<br>
                    右側腹部〜骨盤内の小腸は壁が菲薄で造影効果が減弱している。</p>
              </li>
              
              <li class="carousel-slide">
                <img src="key-images/key4.jpeg" alt="翌日CT" />
                <p class="caption">翌日のCT２<br>
                    上腸間膜静脈径が上腸間脈動脈径よりも細いsmaller SMV signが見られる。</p>
              </li>
              
            </ul>
          </div>
          <button class="carousel-button next">❯</button>
        </div>
        <div class="carousel-indicators"></div>
      </div>
    </section>

    <section class="result-section">
      <h2>■ 解説</h2>
      <div class="explanation">
        <p>帰宅していたため、緊急で呼び出しをした。</p>
        <p>カテーテルを問題なく抜去でき、退院された。</p>
      </div>
    </section>

    <section class="result-section">
      <h2>■ 放射線科医より一言</h2>
      <div class="explanation">
        <p>たとえ活動性出血検索目的であっても、動脈相を撮影した場合は大動脈および主要な分枝（特にSMA）の造営効果があるかどうかは確認しよう。</p>
        <p>腸管由来の症状の可能性がある場合（腹痛、下血）、腸管を一度は確認しよう。</p>
        <p>限局性の腸管の異常（壁肥厚や造影不良）がある場合はそこに行く血管を確認しよう。<br>
          （造影不良があれば絞扼性腸閉塞か、SMA血栓/塞栓/解離かNOMIに大別される）</p>
      </div>
    </section>

    <!-- 問題一覧へ戻る -->
    <div class="back-button">
      <a href="https://da-i-go.github.io/STATlms-home/problems.html">問題一覧へ戻る</a>
    </div>

    <!-- スライド操作スクリプト -->
    <script>
      const track = document.querySelector(".carousel-track");
      const slides = Array.from(track.children);
      const nextButton = document.querySelector(".carousel-button.next");
      const prevButton = document.querySelector(".carousel-button.prev");
      const indicatorsContainer = document.querySelector(".carousel-indicators");

      // インジケーター生成
      slides.forEach((_, index) => {
        const dot = document.createElement("span");
        dot.classList.add("indicator");
        if (index === 0) dot.classList.add("active");
        dot.addEventListener("click", () => {
          currentIndex = index;
          updateSlidePosition();
        });
        indicatorsContainer.appendChild(dot);
      });

      const indicators = indicatorsContainer.querySelectorAll(".indicator");
      let currentIndex = 0;

      function updateSlidePosition() {
        const slideWidth = slides[0].getBoundingClientRect().width;
        track.style.transform = "translateX(-" + slideWidth * currentIndex + "px)";
        indicators.forEach((dot, index) => {
          dot.classList.toggle("active", index === currentIndex);
        });
      }

      nextButton.addEventListener("click", () => {
        currentIndex = (currentIndex + 1) % slides.length;
        updateSlidePosition();
      });

      prevButton.addEventListener("click", () => {
        currentIndex = (currentIndex - 1 + slides.length) % slides.length;
        updateSlidePosition();
      });

      // フリック対応
      let startX = 0;
      track.addEventListener("touchstart", (e) => {
        startX = e.touches[0].clientX;
      });

      track.addEventListener("touchend", (e) => {
        const endX = e.changedTouches[0].clientX;
        const diff = endX - startX;
        if (diff > 50) {
          currentIndex = (currentIndex - 1 + slides.length) % slides.length;
          updateSlidePosition();
        } else if (diff < -50) {
          currentIndex = (currentIndex + 1) % slides.length;
          updateSlidePosition();
        }
      });

      window.addEventListener("load", updateSlidePosition);
      window.addEventListener("resize", updateSlidePosition);
    </script>

    <!-- スプレッドシート記録スクリプト -->
    <script>
      (function () {
        if (sessionStorage.getItem("authenticated") !== "true") return;
        const API =
          "https://script.google.com/macros/s/AKfycbx8b_17MyBUxJtJhJ21KFSfJguUBSGKHBg-WjLHHylbqho1pFjZKIMjvqlMWzUWNFcC/exec"; // GASのURL
        const uid = sessionStorage.getItem("uid") || "";
        const problemId = "4-4"; // 問題番号に変える（変更を忘れないこと）
        const page = location.pathname + location.search;

        fetch(API + "?route=done", {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ uid, problemId, page }),
        }).catch(console.warn);
      })();
    </script>
  </body>
</html>
